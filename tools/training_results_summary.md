# Curriculum è®­ç»ƒç»“æœæ€»ç»“

## âœ… Stage 1 è®­ç»ƒå®Œæˆ

### è®­ç»ƒç»Ÿè®¡
- **æ€»æ­¥æ•°**: 40/40 (100%)
- **è®­ç»ƒæ—¶é—´**: 268.37 ç§’ (~4.5 åˆ†é’Ÿ)
- **è®­ç»ƒé€Ÿåº¦**: 0.149 steps/second, 0.596 samples/second
- **å¹³å‡ Loss**: 0.8428

### Loss å˜åŒ–è¶‹åŠ¿
| Step | Loss | Learning Rate | Gradient Norm |
|------|------|---------------|---------------|
| 10   | 0.9602 | 8.95e-06 | 8.44 |
| 20   | 0.8291 | 5.41e-06 | 10.05 |
| 30   | 0.8006 | 1.61e-06 | 11.60 |
| 40   | 0.7814 | 0.0 | 8.20 |

**Loss ä¸‹é™**: 0.9602 â†’ 0.7814 (ä¸‹é™ 18.6%)

---

## âœ… é…ç½®å¯¹é½æ£€æŸ¥ç»“æœ

### æ£€æŸ¥ç‚¹ 1: Image Tensor é€šé“æ•°
- âœ… **é€šè¿‡**: Image tensor shape: `torch.Size([14, 3, 448, 448])`
- âœ… **é€šé“æ•°**: 3 é€šé“ (æ­£ç¡®)

### æ£€æŸ¥ç‚¹ 2: Depth Tensor é€šé“æ•°  
- âœ… **é€šè¿‡**: Depth tensor shape: `torch.Size([14, 3, 448, 448])`
- âœ… **é€šé“æ•°**: 3 é€šé“ (æ­£ç¡®)
- âœ… **Dtype**: `torch.float32` (åœ¨è¿›å…¥æ¨¡å‹å‰ä¼šè½¬æ¢ä¸º bfloat16)

### æ£€æŸ¥ç‚¹ 3: LayerNorm dtype ä¸€è‡´æ€§
- âœ… **é€šè¿‡**: DeepSpeed ZeRO-3 è‡ªåŠ¨å¤„ç† bfloat16 å…¼å®¹æ€§
- âœ… **æ— é”™è¯¯**: æ²¡æœ‰å‡ºç° "expected scalar type Float but found BFloat16" é”™è¯¯

### æ£€æŸ¥ç‚¹ 4: Image/Depth ç©ºé—´ç»´åº¦ä¸€è‡´æ€§
- âœ… **é€šè¿‡**: Spatial consistent: image=`torch.Size([14, 3, 448, 448])`, depth=`torch.Size([14, 3, 448, 448])`
- âœ… **ç©ºé—´ç»´åº¦**: (448, 448) - å®Œå…¨ä¸€è‡´

---

## ğŸ“ ä¿å­˜çš„ Checkpoint

### Stage 1 è¾“å‡ºç›®å½•
`/local_data/ky2738/snpp-msg/snpp-msg-conversion/scannetpp-main/RoboRefer/runs/train/Curriculum-25pct-Stage1/`

### ä¿å­˜çš„ç»„ä»¶
- âœ… `llm/` - è¯­è¨€æ¨¡å‹
- âœ… `vision_tower/` - è§†è§‰ç¼–ç å™¨
- âœ… `mm_projector/` - å¤šæ¨¡æ€æŠ•å½±å™¨
- âœ… `depth_tower/` - æ·±åº¦ç¼–ç å™¨
- âœ… `depth_projector/` - æ·±åº¦æŠ•å½±å™¨
- âœ… `checkpoint-40/` - Step 40 çš„å®Œæ•´ checkpoint
- âœ… `trainer_state.json` - è®­ç»ƒçŠ¶æ€

---

## ğŸ”§ åº”ç”¨çš„ä¿®å¤

### 1. é€šé“æ•°ä¿®å¤
- å¢å¼ºäº† `_ensure_depth_3channels` å‡½æ•°ï¼Œæ”¯æŒ 3D å’Œ 4D tensor
- åœ¨æ‰€æœ‰å…³é”®ä½ç½®æ·»åŠ äº†æ£€æŸ¥ï¼š
  - `process_depth`
  - `dynamic_process_depths_and_prompt`
  - `encode_images`
  - `basic.py` encoder

### 2. BFloat16 å…¼å®¹æ€§
- ä½¿ç”¨ DeepSpeed ZeRO-3 è‡ªåŠ¨å¤„ç† dtype è½¬æ¢
- æ·»åŠ äº† `patch_layer_norm_for_bf16` ä½œä¸ºé¢å¤–ä¿æŠ¤

### 3. æ˜¾å­˜ä¼˜åŒ–
- `max_tiles`: 12 â†’ 4
- `model_max_length`: 16384 â†’ 4096
- `torch_empty_cache_steps`: æ¯ 1 æ­¥æ¸…ç†æ˜¾å­˜
- ä½¿ç”¨ `PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True`

### 4. è®­ç»ƒé…ç½®å¯¹é½
- ä½¿ç”¨ DeepSpeed ZeRO-3 (ä¸å®˜æ–¹ä¸€è‡´)
- ä½¿ç”¨ `torch.distributed.run` å¯åŠ¨è®­ç»ƒ
- æ‰€æœ‰æ£€æŸ¥ç‚¹è‡ªåŠ¨éªŒè¯

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ˜¾å­˜è­¦å‘Š
è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°äº†å¤šæ¬¡ "pytorch allocator cache flushes" è­¦å‘Šï¼Œè¿™æ˜¯æ˜¾å­˜å‹åŠ›å¯¼è‡´çš„ï¼Œä½†ä¸å½±å“è®­ç»ƒè¿›è¡Œã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š
- è¿›ä¸€æ­¥é™ä½ `max_tiles` (å½“å‰ 4)
- é™ä½ `model_max_length` (å½“å‰ 4096)
- å¢åŠ  `torch_empty_cache_steps` é¢‘ç‡

### è®­ç»ƒçŠ¶æ€
- Stage 1: âœ… å®Œæˆ (40 steps)
- Stage 2: ğŸ”„ è¿›è¡Œä¸­ (ä» Stage 1 checkpoint resume)
- Stage 3: â³ ç­‰å¾…ä¸­

---

## ğŸ“Š è®­ç»ƒè´¨é‡æŒ‡æ ‡

### Loss è¶‹åŠ¿
- **åˆå§‹ Loss**: 0.9602
- **æœ€ç»ˆ Loss**: 0.7814
- **ä¸‹é™å¹…åº¦**: 18.6%
- **è¶‹åŠ¿**: æŒç»­ä¸‹é™ï¼Œè®­ç»ƒæ­£å¸¸

### æ¢¯åº¦ç¨³å®šæ€§
- **Gradient Norm**: 8.20 - 11.60 (æ­£å¸¸èŒƒå›´)
- **æ— æ¢¯åº¦çˆ†ç‚¸**: æ‰€æœ‰æ¢¯åº¦èŒƒæ•°éƒ½åœ¨åˆç†èŒƒå›´å†…

---

## âœ… ç»“è®º

**æ‰€æœ‰ä¿®å¤å·²æˆåŠŸåº”ç”¨ï¼Œè®­ç»ƒé…ç½®ä¸å®˜æ–¹å¯¹é½ï¼Œè®­ç»ƒæ­£å¸¸è¿›è¡Œï¼**

---

## ğŸ” å®Œæ•´æ€§æ£€æŸ¥ç»“æœ

### Checkpoint å®Œæ•´æ€§
- âœ… **llm**: 2.96 GB
- âœ… **vision_tower**: 788.41 MB
- âœ… **depth_tower**: 788.41 MB
- âœ… **mm_projector**: 83.04 MB
- âœ… **depth_projector**: 83.04 MB
- âœ… **trainer_state.json**: å­˜åœ¨
- âœ… **config.json**: å­˜åœ¨

**æ€»è®¡**: 7/7 ç»„ä»¶å®Œæ•´ï¼Œæ€»å¤§å° 4.59 GB

### è®­ç»ƒçŠ¶æ€éªŒè¯
- âœ… **Global Step**: 40/40 (100%)
- âœ… **è®­ç»ƒå®Œæˆ**: æ˜¯
- âœ… **Loss ä¸‹é™**: 18.62% (0.9602 â†’ 0.7814)

### é…ç½®å¯¹é½éªŒè¯
- âœ… **Image é€šé“æ•°**: 3 é€šé“ (éªŒè¯é€šè¿‡)
- âœ… **Depth é€šé“æ•°**: 3 é€šé“ (éªŒè¯é€šè¿‡)
- âœ… **ç©ºé—´ç»´åº¦ä¸€è‡´æ€§**: (448, 448) (éªŒè¯é€šè¿‡)
- âœ… **LayerNorm dtype**: æ— é”™è¯¯ (éªŒè¯é€šè¿‡)

### é”™è¯¯æ£€æŸ¥
- âš ï¸ **torchvision è­¦å‘Š**: ä»…ç¯å¢ƒè­¦å‘Šï¼Œä¸å½±å“è®­ç»ƒ
- âœ… **æ— ä¸¥é‡é”™è¯¯**: æ—  RuntimeErrorã€ValueErrorã€TypeError

### åç»­é˜¶æ®µçŠ¶æ€
- **Stage 1**: âœ… å®Œæˆ
- **Stage 2**: â³ ç›®å½•å·²åˆ›å»ºï¼Œç­‰å¾…å¼€å§‹
- **Stage 3**: â³ ç­‰å¾…ä¸­

---

## ğŸ“ æ£€æŸ¥è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯éšæ—¶æ£€æŸ¥è®­ç»ƒç»“æœï¼š
```bash
cd RoboRefer
python3 tools/check_training_results.py
```
